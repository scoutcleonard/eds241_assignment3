---
title: "EDS241: Assignment 3"
author: "Scou Leonard"
date: '`r format(Sys.time(), "%m/%d/%Y")`'
output: 
  pdf_document:
    toc: false
    number_sections: yes
header-includes:
  - \setlength{\parindent}{1em}
  - \usepackage{float}
--- 

``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
# set default chunk options
knitr::opts_chunk$set(fig.width = 4, fig.height = 3, 
                      echo = TRUE, message = FALSE, warning = FALSE)


# load packages
packages=c("stargazer", 
           "here", 
           "tidyr", 
           "dplyr",
           "stringr", 
           "janitor", 
           "cowplot", 
           "ggplot2", 
           "tinytex", 
           "datasets", 
           "tibble",
           "here",
           "tidyverse",
           "estimatr")

for (i in packages) {
  if (require(i,character.only=TRUE)==FALSE) {
    install.packages(i,repos='http://cran.us.r-project.org')
  }
  else {
    require(i,character.only=TRUE)
  }
}

#devtools::install_github('rstudio/rmarkdown')
options(scipen=999) # not scientific notation
```

\noindent This exercise asks you to implement some of the techniques presented in Lectures 6-7. The goal is to estimate the causal effect of maternal smoking during pregnancy on infant birth weight using the treatment ignorability assumptions. The data are taken from the National Natality Detail Files, and the extract “SMOKING_EDS241.csv”' is a random sample of all births in Pennsylvania during 1989-1991. Each observation is a mother-infant pair. The key variables are:

**The outcome and treatment variables are:**

- `birthwgt` = birth weight if infant in grams
- `tobacco` = indicator for maternal smoking 

**The control variables are:**

- `mage`: mother's age
- `meduc`: mother's education
- `mblack`: = 1 if mother is Black
- `alcohol`: =1 if consumed alcohol during pregnancy
- `first`: =1 if first child
- `diabete`: = 1 if mother is diabetic
- `anemia`: =1 if mother anemic 

# Load and Clean Data 

```{r}
#read in the data
smoking_df <- read.csv(here("data", "SMOKING_EDS241.csv"))
```

\newpage 

\noindent (a) What is the unadjusted mean difference in birth weight of infants with smoking and non- smoking mothers? Under what hypothesis does this correspond to the average treatment effect of maternal smoking during pregnancy on infant birth weight? Provide some simple empirical evidence for or against this hypothesis.

*OH NOTES*
If we are not adjusting on anything, what is the assumption 
This is randomization of treatment, but unconditional randomization of treatment  
Smoking status is randomly assigned between mothers - the assumption

statitsical significance fodifference in birthweights does not tell you anything about random assignment of smoking treatment -> we need random assignment of smoking status

Evidence: we need to show that any statistical difference between mothers that smoke and mothers that don't smoke -> run a model: income ~ tobacco, educ ~ tobacco, age ~ tobacco _are the means statitsically differnece for these?_ 
provide some evidence that smoking is correlated with these variables . note the p values ! 

hypothesis: testing that treatment is independent of potential outcomes.
what would need to be true for the difference in weights to be the average treatment effect? 
unconditional treatment ignorability 
*END*
```{r}
lm_robust(birthwgt ~ tobacco, data = smoking_df)
```


```{r}

```

The unadjusted mean difference in birth weight of infants with smoking and non- smoking mothers is -244.5 grams. 

This corresponds to the alternative hypothesis that there is a difference between the infant birthweight between those with and without maternal smoking during pregnancy, holding all else equal regarding the mother's pregnancy and health. 

Evidence against this hypothesis is that not all pregnancies and maternal health is equal; a mother living in wealth who smokes might have a heavier baby than a mother who lives in poverty and does not smoke, for example, if socioeconomic status has an impact on infant birth weight. 

\newpage

\noindent (b) Assume that maternal smoking is randomly assigned conditional on the observable covariates listed above. Estimate the effect of maternal smoking on birth weight using a linear regression. Report the estimated coefficient on tobacco and its standard error.

**OH NOTES**

because it is conditional on the other variables, we include them all

in order to get the ate, they need to be as factors. but here, maybe we do them linearly. 

getting towards matching and conditioning on observables. 

the simplest way to start controlling for the covarites is to linearly include them  

**END**
```{r}
# should we include the mage and meduc variables as.factor?? 
mod <- lm_robust(birthwgt ~ tobacco + mage + meduc + as.factor(mblack) + as.factor(alcohol) + as.factor(first) + as.factor(diabete) + as.factor(anemia), data = smoking_df)

mod

#se
mod[[2]][[2]]
```

The average effect of maternal smoking on birth weight when all other covarients are held equal is -236.46 grams with a standard error of 4.28. 

\newpage

\noindent (c) Use the exact matching estimator to estimate the effect of maternal smoking on birth weight. For simplicity, consider the following covariates in your matching estimator: create a 0-1 indicator for mother's age (=1 if mage>=34), and a 0-1 indicator for mother's education (1 if meduc>=16), mother's race (mblack), and alcohol consumption indicator (alcohol). These 4 covariates will create 2*2*2*2 = 16 cells. Report the estimated average treatment effect of smoking on birthweight using the exact matching estimator and its linear regression analogue (Lecture 6, slides 12-14).

```{r}
#create indicators for mage and meduc 
smoking_df <- smoking_df %>% 
  mutate(mage_indicator = case_when(mage >= 34 ~ 1,
                                    mage < 34 ~ 0)) %>% 
  mutate(meduc_indicator = case_when(meduc >= 16 ~ 1,
                                     meduc < 16 ~ 0))
```

**MAKE SURE u are running a fully saturated model google this**

```{r}
#exact matching estimater 
mod_2 <- lm_robust(birthwgt ~ tobacco + as.factor(mage_indicator) + as.factor(meduc_indicator) + as.factor(mblack) + as.factor(alcohol), data = smoking_df)

mod_2

#rewriting but interact stuff
mod_2 <- lm_robust(birthwgt ~ tobacco + as.factor(mage_indicator) + as.factor(meduc_indicator) + as.factor(mblack) + as.factor(alcohol), data = smoking_df)
#LINEAR REG ANALOGUE 
#there should be 15
mod_2 <- lm_robust(birthwgt ~  tobacco +
                     as.factor(mage_indicator) + 
                     as.factor(meduc_indicator) + 
                     as.factor(mblack) + 
                     as.factor(alcohol) + 
                     tobacco:as.factor(mage_indicator) + 
                     tobacco:as.factor(meduc_indicator) + 
                     tobacco:as.factor(mblack) + 
                     tobacco:as.factor(alcohol) +
                     as.factor(mage_indicator):as.factor(meduc_indicator) +
                     as.factor(mage_indicator):as.factor(mblack) +
                     as.factor(mage_indicator):as.factor(alcohol) +
                     as.factor(meduc_indicator):as.factor(mblack) +
                     as.factor(meduc_indicator):as.factor(alcohol) +
                     as.factor(mblack):as.factor(alcohol) +
                     tobacco:as.factor(mage_indicator):as.factor(meduc_indicator) +
                     tobacco:as.factor(mage_indicator):as.factor(mblack) +
                     tobacco:as.factor(mage_indicator):as.factor(alcohol) +
                     as.factor(mage_indicator):as.factor(meduc_indicator):as.factor(mblack) +
                     as.factor(mage_indicator):as.factor(meduc_indicator):as.factor(alcohol) +
                     as.factor(meduc_indicator):as.factor(mblack):as.factor(alcohol) +
                     )

#matching TIA pull from TIA table 
```

The estimated average treatment effect of smoking on birthweight using the exact matching estimator is -226.76 grams lower for maternal smoking during pregnancy. 

It lin

\newpage 

\noindent (d) Estimate the propensity score for maternal smoking using a logit estimator and based on the following specification: mother’s age, mother’s age squared, mother’s education, and indicators for mother’s race, and alcohol consumption.

```{r}
# BASIC PROPENSITY SCORE --- THIS IS A TOY MODEL
# ESTIMATE PROPENSITY SCORE MODEL AND PREDICT (EPS)
ps_model <- glm(tobacco ~ mage + mage^2 + meduc + mblack + alcohol, family = binomial(), data = smoking_df)
summary(ps_model)
EPS <- predict(ps_model, type = "response")
```

\newpage

\noindent (e) Use the propensity score weighted regression (WLS) to estimate the effect of maternal smoking on birth weight (Lecture 7, slide 12).

